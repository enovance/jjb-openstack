- job:
    name: 'upgrade'
    description: 'Upgrade Spinal Stack'
    project-type: freestyle
    wrappers:
      - ansicolor:
          colormap: xterm
    builders:
      - shell: |
          set -e
          source /etc/config-tools/config
          export ANSIBLE_HOST_KEY_CHECKING=false
          for template in site.yml hosts group_vars/all; do
            generate.py 0 /etc/config-tools/global.yml /etc/ansible/$template.tmpl|grep -v '^$' |sudo tee /etc/ansible/$template > /dev/null
            sudo chmod 0644 /etc/ansible/$template
          done
          for p in $PROFILES; do
            for tag in {1..9}; do
              ansible-playbook -s -M /srv/edeploy/ansible/library /etc/ansible/site.yml -v --tags $tag -l $p
            done
          done
          for step in 0 5; do
            echo $step | sudo tee /etc/config-tools/step
            configure.sh $step
          done
          ret=$?
          exit $ret
